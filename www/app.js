const stateKey="mdiyoniyat_state_v1";let state={people:{}};function save(){localStorage.setItem(stateKey,JSON.stringify(state));}function load(){const s=localStorage.getItem(stateKey);if(s){try{state=JSON.parse(s);}catch(e){state={people:{}}}}}function fmt(n){return Number(n||0).toFixed(2)}function today(){const d=new Date();const dd=d.getDate().toString().padStart(2,"0");const mm=(d.getMonth()+1).toString().padStart(2,"0");const yy=d.getFullYear().toString();return `${dd}/${mm}/${yy}`}function personTotal(p){const debts=(p.debts||[]).reduce((a,b)=>a+Number(b.amount||0),0);const pays=(p.pays||[]).reduce((a,b)=>a+Number(b.amount||0),0);return debts-pays}function grandTotal(){return Object.values(state.people).reduce((a,p)=>a+personTotal(p),0)}
const grandTotalEl=document.getElementById("grandTotal");const peopleList=document.getElementById("peopleList");const importBtn=document.getElementById("importBtn");const importModal=document.getElementById("importModal");const nameInput=document.getElementById("nameInput");const suggestions=document.getElementById("suggestions");const addNameBtn=document.getElementById("addNameBtn");const debtModal=document.getElementById("debtModal");const debtAmount=document.getElementById("debtAmount");const debtOk=document.getElementById("debtOk");const payModal=document.getElementById("payModal");const payAmount=document.getElementById("payAmount");const payOk=document.getElementById("payOk");const showModal=document.getElementById("showModal");const ledgerTable=document.getElementById("ledgerTable").querySelector("tbody");const finalModal=document.getElementById("finalModal");const finalPerson=document.getElementById("finalPerson");const finalAmount=document.getElementById("finalAmount");let currentPerson=null;let contactsCache=[];function openModal(m){m.classList.add("show")}function closeModal(m){m.classList.remove("show")}document.querySelectorAll("[data-close]").forEach(b=>b.addEventListener("click",()=>{document.querySelectorAll(".modal").forEach(closeModal)}));function render(){peopleList.innerHTML="";Object.keys(state.people).forEach(name=>{const p=state.people[name];const li=document.createElement("li");li.className="list-item";const left=document.createElement("div");left.className="left";const nm=document.createElement("div");nm.className="name";nm.textContent=name;const tot=document.createElement("div");tot.className="muted";tot.textContent=`الإجمالي: ${fmt(personTotal(p))}`;left.appendChild(nm);left.appendChild(tot);const actions=document.createElement("div");actions.className="actions";const a1=document.createElement("button");a1.className="action danger";a1.textContent="تسجيل مديونية";a1.addEventListener("click",()=>{currentPerson=name;debtAmount.value="";openModal(debtModal)});const a2=document.createElement("button");a2.className="action success";a2.textContent="سداد";a2.addEventListener("click",()=>{currentPerson=name;payAmount.value="";openModal(payModal)});const a3=document.createElement("button");a3.className="action info";a3.textContent="عرض";a3.addEventListener("click",()=>{currentPerson=name;fillLedger(name);openModal(showModal)});const a4=document.createElement("button");a4.className="action";a4.textContent="نهائي";a4.addEventListener("click",()=>{currentPerson=name;finalPerson.textContent=name;finalAmount.textContent=fmt(personTotal(state.people[name]));openModal(finalModal)});actions.appendChild(a1);actions.appendChild(a2);actions.appendChild(a3);actions.appendChild(a4);li.appendChild(left);li.appendChild(actions);peopleList.appendChild(li)});grandTotalEl.textContent=fmt(grandTotal());save()}function ensurePerson(name){if(!state.people[name]){state.people[name]={debts:[],pays:[]}}}
debtOk.addEventListener("click",()=>{const v=Number(debtAmount.value);if(!currentPerson||isNaN(v)||v<=0){closeModal(debtModal);return}ensurePerson(currentPerson);state.people[currentPerson].debts.push({amount:v,date:today()});closeModal(debtModal);render()});payOk.addEventListener("click",()=>{const v=Number(payAmount.value);if(!currentPerson||isNaN(v)||v<=0){closeModal(payModal);return}ensurePerson(currentPerson);state.people[currentPerson].pays.push({amount:v,date:today()});closeModal(payModal);render()});function fillLedger(name){const p=state.people[name];ledgerTable.innerHTML="";(p.debts||[]).forEach(x=>{const tr=document.createElement("tr");tr.className="row-debt";const td1=document.createElement("td");td1.textContent="مديونية";const td2=document.createElement("td");td2.textContent=fmt(x.amount);const td3=document.createElement("td");td3.textContent=x.date;tr.appendChild(td1);tr.appendChild(td2);tr.appendChild(td3);ledgerTable.appendChild(tr)});(p.pays||[]).forEach(x=>{const tr=document.createElement("tr");tr.className="row-pay";const td1=document.createElement("td");td1.textContent="سداد";const td2=document.createElement("td");td2.textContent=fmt(x.amount);const td3=document.createElement("td");td3.textContent=x.date;tr.appendChild(td1);tr.appendChild(td2);tr.appendChild(td3);ledgerTable.appendChild(tr)})}
function filterSuggestions(q){const list=(contactsCache||[]).filter(n=>n&&n.toLowerCase().includes(q.toLowerCase())).slice(0,20);suggestions.innerHTML="";list.forEach(n=>{const li=document.createElement("li");li.className="suggestion";li.textContent=n;li.addEventListener("click",()=>{nameInput.value=n;suggestions.innerHTML=""});suggestions.appendChild(li)});}nameInput.addEventListener("input",e=>{const q=e.target.value||"";if(q.trim().length===0){suggestions.innerHTML="";return}filterSuggestions(q)});addNameBtn.addEventListener("click",()=>{const n=(nameInput.value||"").trim();if(!n){return}ensurePerson(n);nameInput.value="";suggestions.innerHTML="";render()});importBtn.addEventListener("click",async()=>{openModal(importModal);await loadContactsOnce()});async function loadContactsOnce(){if(contactsCache.length>0){return}const names=new Set();let ok=false;try{if(window.navigator&&navigator.contacts&&navigator.contacts.find){const fields=["displayName","name"];const options=new ContactFindOptions();options.multiple=true;navigator.contacts.find(fields,(results)=>{try{results.forEach(c=>{const dn=c.displayName||c.nickname||null;const fn=c.name&&c.name.givenName?c.name.givenName:null;const ln=c.name&&c.name.familyName?c.name.familyName:null;const composed=[dn,[fn,ln].filter(Boolean).join(" ")].filter(Boolean)[0];if(composed)names.add(composed)});contactsCache=Array.from(names)}catch(e){}},()=>{},options)} }catch(e){}try{if(!ok&&window.Capacitor&&window.Capacitor.Plugins&&window.Capacitor.Plugins.Contacts){const res=await window.Capacitor.Plugins.Contacts.getContacts();if(res&&res.contacts){res.contacts.forEach(c=>{const dn=c.displayName||c.name||null;if(dn)names.add(dn)});contactsCache=Array.from(names);ok=true}}}catch(e){}}
function init(){load();render()}document.addEventListener("DOMContentLoaded",init);
